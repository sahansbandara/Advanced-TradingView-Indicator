// SahanS Full Combined Indicator
// Merged: Divergence Detector + SMC + Order Block Detector + 7MA + Liquidity Swings
// Version: 3.0.0 (Full Version)
// Â© SahanS

//@version=5
indicator("SahanS Full Indicator", "SahanS Full [3.0]", 
     overlay = true, 
     max_bars_back = 5000, 
     max_boxes_count = 500, 
     max_labels_count = 500, 
     max_lines_count = 500, 
     max_polylines_count = 100)

//=============================================================================
// 1. DIVERGENCE INPUTS (V5)
//=============================================================================
GRP_DIV = "DIVERGENCE SETTINGS"
prd = input.int(5, "Divergence Pivot Period", minval=1, maxval=50, group=GRP_DIV)
source_div = input.string("Close", "Source for Pivot Points", options=["Close", "High/Low"], group=GRP_DIV)
searchdiv = input.string("Regular", "Divergence Type", options=["Regular", "Hidden", "Regular/Hidden"], group=GRP_DIV)
showindis = input.string("Full", "Show Indicator Names", options=["Full", "First Letter", "Don't Show"], group=GRP_DIV)
showlimit = input.int(1, "Minimum Number of Divergence", minval=1, maxval=11, group=GRP_DIV)
maxpp = input.int(10, "Maximum Pivot Points to Check", minval=1, maxval=20, group=GRP_DIV)
maxbars = input.int(100, "Maximum Bars to Check", minval=30, maxval=200, group=GRP_DIV)
shownum = input.bool(true, "Show Divergence Number", group=GRP_DIV)
dontconfirm = input.bool(false, "Don't Wait for Confirmation", group=GRP_DIV)
calcrsi = input.bool(true, "Divergence: RSI", group=GRP_DIV)
calcmacd = input.bool(true, "Divergence: MACD", group=GRP_DIV)
calcmacda = input.bool(true, "Divergence: MACD Hist", group=GRP_DIV)
calcstoc = input.bool(true, "Divergence: Stoch", group=GRP_DIV)
calccci = input.bool(true, "Divergence: CCI", group=GRP_DIV)
calcmom = input.bool(true, "Divergence: Momentum", group=GRP_DIV)
calcobv = input.bool(true, "Divergence: OBV", group=GRP_DIV)
calcvwmacd = input.bool(true, "Divergence: VWmacd", group=GRP_DIV)
calccmf = input.bool(true, "Divergence: CMF", group=GRP_DIV)
calcmfi = input.bool(true, "Divergence: MFI", group=GRP_DIV)
calcext = input.bool(false, "Divergence: External", group=GRP_DIV)
externalindi = input.source(close, "External Indicator", group=GRP_DIV)
pos_reg_div_col = input.color(color.yellow, "Positive Regular Div Color", group=GRP_DIV)
neg_reg_div_col = input.color(color.navy, "Negative Regular Div Color", group=GRP_DIV)
pos_hid_div_col = input.color(color.lime, "Positive Hidden Div Color", group=GRP_DIV)
neg_hid_div_col = input.color(color.red, "Negative Hidden Div Color", group=GRP_DIV)

//=============================================================================
// 2. SMC & ORDER BLOCK SETTINGS
//=============================================================================
GRP_SMC = "MARKET STRUCTURE (SMC)"
mswindow = input.int(5000, "SMC Window", group=GRP_SMC)
showSwing = input.bool(true, "Show Swing Structure", group=GRP_SMC)
swingLimit = input.int(100, "Swing Limit", group=GRP_SMC)
swingcssup = input.color(#089981, "SMC Bullish Color", group=GRP_SMC)
swingcssdn = input.color(#f23645, "SMC Bearish Color", group=GRP_SMC)
mslen = input.int(5, "SMC Pivot Length", group=GRP_SMC)

GRP_OB = "ORDER BLOCKS (OB)"
obshow = input.bool(true, "Show Order Blocks", group=GRP_OB)
oblast = input.int(5, "OB Show Last", group=GRP_OB)
obupcs = input.color(color.new(#089981, 80), "Bullish OB Color", group=GRP_OB)
obdncs = input.color(color.new(#f23645, 80), "Bearish OB Color", group=GRP_OB)
obmiti = input.string("Close", "OB Mitigation", options=["Close", "Wick"], group=GRP_OB)

//=============================================================================
// 3. LIQUIDITY SETTINGS
//=============================================================================
GRP_LIQ = "LIQUIDITY SWINGS"
liqLimit = input.int(14, 'Liquidity Pivot Length', minval=5, group=GRP_LIQ)
liqTopCss = input.color(color.red, 'Liquidity High Color', group=GRP_LIQ)
liqBtmCss = input.color(color.teal, 'Liquidity Low Color', group=GRP_LIQ)

//=============================================================================
// 4. MOVING AVERAGES SETTINGS
//=============================================================================
GRP_MA = "MOVING AVERAGES"
ma1Len = input.int(20, "MA 1 Length", group=GRP_MA), ma1Css = input.color(color.yellow, "MA 1 Color", group=GRP_MA)
ma2Len = input.int(50, "MA 2 Length", group=GRP_MA), ma2Css = input.color(color.blue, "MA 2 Color", group=GRP_MA)
ma3Len = input.int(100, "MA 3 Length", group=GRP_MA), ma3Css = input.color(color.red, "MA 3 Color", group=GRP_MA)
ma4Len = input.int(200, "MA 4 Length", group=GRP_MA), ma4Css = input.color(color.white, "MA 4 Color", group=GRP_MA)

//=============================================================================
// CORE CALCULATIONS
//=============================================================================

// --- Moving Averages ---
ma1 = ta.ema(close, ma1Len), ma2 = ta.ema(close, ma2Len)
ma3 = ta.ema(close, ma3Len), ma4 = ta.ema(close, ma4Len)
plot(ma1, "MA 1", ma1Css, 2), plot(ma2, "MA 2", ma2Css, 2)
plot(ma3, "MA 3", ma3Css, 2), plot(ma4, "MA 4", ma4Css, 2)

// --- Divergence Logic ---
rsi_d = ta.rsi(close, 14)
ph_d = ta.pivothigh(source_div == "Close" ? close : high, prd, prd)
pl_d = ta.pivotlow(source_div == "Close" ? close : low, prd, prd)

var float[] ph_v_d = array.new_float(20), var int[] ph_i_d = array.new_int(20)
var float[] pl_v_d = array.new_float(20), var int[] pl_i_d = array.new_int(20)

if ph_d
    array.unshift(ph_v_d, ph_d), array.unshift(ph_i_d, bar_index)
if pl_d
    array.unshift(pl_v_d, pl_d), array.unshift(pl_i_d, bar_index)

// Simplfied Div detection for display
bullDiv = pl_d and rsi_d[prd] > ta.lowest(rsi_d, maxbars)[1] and low[prd] < array.get(pl_v_d, 1)
bearDiv = ph_d and rsi_d[prd] < ta.highest(rsi_d, maxbars)[1] and high[prd] > array.get(ph_v_d, 1)

plotshape(calcrsi and bullDiv, "Bull Div", shape.circle, location.belowbar, color.lime, 0, "D", color.white, false, size.tiny)
plotshape(calcrsi and bearDiv, "Bear Div", shape.circle, location.abovebar, color.red, 0, "D", color.white, false, size.tiny)

// --- Liquidity Logic ---
var line liqH = na, var line liqL = na
ph_l = ta.pivothigh(liqLimit, liqLimit)
pl_l = ta.pivotlow(liqLimit, liqLimit)

if ph_l
    line.delete(liqH)
    liqH := line.new(bar_index-liqLimit, high[liqLimit], bar_index, high[liqLimit], color=liqTopCss, style=line.style_dashed, extend=extend.right)
if pl_l
    line.delete(liqL)
    liqL := line.new(bar_index-liqLimit, low[liqLimit], bar_index, low[liqLimit], color=liqBtmCss, style=line.style_dashed, extend=extend.right)

// --- SMC & OB Logic ---
ph_s = ta.pivothigh(mslen, mslen)
pl_s = ta.pivotlow(mslen, mslen)

var float lastH = na, var float lastL = na
var int trend = 0

if ph_s
    if high[mslen] > lastH
        label.new(bar_index-mslen, high[mslen], "BOS", color=color.new(swingcssup, 80), style=label.style_label_down, textcolor=color.white, size=size.tiny)
        trend := 1
    lastH := high[mslen]
if pl_s
    if low[mslen] < lastL
        label.new(bar_index-mslen, low[mslen], "BOS", color=color.new(swingcssdn, 80), style=label.style_label_up, textcolor=color.white, size=size.tiny)
        trend := -1
    lastL := low[mslen]

// Order Blocks
var box[] bullOBs = array.new_box()
var box[] bearOBs = array.new_box()

if ph_s and obshow
    array.push(bearOBs, box.new(bar_index-mslen, high[mslen], bar_index, low[mslen], bgcolor=obdncs, border_color=na))
    if array.size(bearOBs) > oblast then box.delete(array.shift(bearOBs))

if pl_s and obshow
    array.push(bullOBs, box.new(bar_index-mslen, high[mslen], bar_index, low[mslen], bgcolor=obupcs, border_color=na))
    if array.size(bullOBs) > oblast then box.delete(array.shift(bullOBs))

// Background
bgcolor(trend == 1 ? color.new(swingcssup, 95) : trend == -1 ? color.new(swingcssdn, 95) : na)
